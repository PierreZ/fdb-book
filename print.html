<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>the FoundationDB Book</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="welcome.html">The FoundationDB Book</a></li><li class="chapter-item expanded affix "><li class="part-title">Meet FoundationDB</li><li class="chapter-item expanded "><a href="meet_fdb/another_db.html"><strong aria-hidden="true">1.</strong> Yet another database?</a></li><li class="chapter-item expanded "><a href="meet_fdb/enter_fdb.html"><strong aria-hidden="true">2.</strong> Enter FoundationDB</a></li><li class="chapter-item expanded "><a href="meet_fdb/everything_is_kv.html"><strong aria-hidden="true">3.</strong> Everything is a key-value!</a></li><li class="chapter-item expanded "><a href="meet_fdb/correctess.html"><strong aria-hidden="true">4.</strong> Correct and robust, choose both</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started with FoundationDB</li><li class="chapter-item expanded "><a href="getting_started/installing-fdb.html"><strong aria-hidden="true">5.</strong> Installing FoundationDB</a></li><li class="chapter-item expanded "><a href="getting_started/fdbcli.html"><strong aria-hidden="true">6.</strong> Playing with fdbcli</a></li><li class="chapter-item expanded affix "><li class="part-title">Developing a layer</li><li class="chapter-item expanded "><a href="develop_layer/crafting-row-keys.html"><strong aria-hidden="true">7.</strong> Crafting row keys</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> TODO: Transaction</div></li><li class="chapter-item expanded "><a href="develop_layer/tips.html"><strong aria-hidden="true">9.</strong> Tips and tricks</a></li><li class="chapter-item expanded affix "><li class="part-title">FoundationDB's internals</li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> TODO: the list of roles</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> TODO: the write-path</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> TODO: the read-path</div></li><li class="chapter-item expanded affix "><li class="part-title">The Record-Layer</li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> TODO: What is the Record-layer?</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> TODO: QuiCK</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
<script defer data-domain="pierrez.github.io/fdb-book" src="https://plausible.io/js/plausible.js"></script>                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">the FoundationDB Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PierreZ/fdb-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="FDB_logo.png" alt="FDB_logo.png" /></p>
<h1 id="the-foundationdbs-book-"><a class="header" href="#the-foundationdbs-book-">The FoundationDB's Book üìñ</a></h1>
<p>Welcome to FoundationDB's Book! If you are looking to start writing your own datastore with FoundationDB, or if you are curious about FDB, you have come to the right place.</p>
<p>üöß This is currently a work-in-progress, feel free to <a href="https://github.com/PierreZ/fdb-book">contribute</a> chapters! üöß</p>
<h2 id="what-this-book-covers"><a class="header" href="#what-this-book-covers">What This Book Covers</a></h2>
<p>This book aims to be a comprehensive, up-to-date guide to use FoundationDB features and libraries, appropriate for beginners and old hands alike.</p>
<p>It is designed as <strong>an entrypoint towards the FoundationDB's community</strong>, with links pointing to the <a href="https://apple.github.io/foundationdb/">official documentation</a> or the <a href="https://forums.foundationdb.org/">forum</a>.</p>
<ul>
<li>The early chapters provide an introduction to FoundationDB, why it may interest you, and what is a layer.</li>
<li>The Record-Layer chapter is focusing on the Record-Layer, a Java library to write layers made by Apple.</li>
<li>The middle chapters discuss key utilities and features provided by the bindings, and describe best-practises to write layers to maximize performance and scalability.</li>
<li>The last chapters are describing core elements of FoundationDB, such as read/write path, or the simulation framework.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="yet-another-database"><a class="header" href="#yet-another-database">Yet another database?</a></h1>
<ul>
<li><a href="meet_fdb/another_db.html#how-to-choose-a-database">How to choose a database?</a></li>
<li><a href="meet_fdb/another_db.html#stateless-applications">Stateless applications</a></li>
<li><a href="meet_fdb/another_db.html#datastores-architecture">Datastore's architecture</a></li>
<li><a href="meet_fdb/another_db.html#sharing-the-storage-engine-">Sharing the storage engine ü§î</a></li>
<li><a href="meet_fdb/another_db.html#requirements-for-such-a-storage-engine">Requirements for such a storage engine</a></li>
</ul>
<blockquote>
<p>Another database? There is so many of them üòë</p>
</blockquote>
<p>You are right, we are living in the golden age of data, and as such, we have many options to store our data.</p>
<p>According to the <a href="https://dbdb.io/">Database of Databases</a>, you can choose between <strong>795 database management systems</strong>. Yes, you read it right, almost 800 different databases to compare üò±</p>
<h2 id="how-to-choose-a-database"><a class="header" href="#how-to-choose-a-database">How to choose a database?</a></h2>
<p>If you click on the <a href="https://dbdb.io/browse">Browse button</a>, you will be able to go through the different criteria:</p>
<ul>
<li>is it open-source or not?</li>
<li>is it an embedded/single-node/distributed database?</li>
<li>What is the query language?</li>
<li>is it suited for <a href="https://en.wikipedia.org/wiki/Online_transaction_processing">OTLP</a> or <a href="https://en.wikipedia.org/wiki/Online_analytical_processing">OLAP</a> workloads?</li>
<li>What is the data model?</li>
<li>What is the scalability limits?</li>
<li>Is it transactional?</li>
<li>Is there indexes?</li>
<li>Is it a row-oriented storage, or maybe columnar?</li>
<li>is there stored procedures and materialized views?</li>
<li>and so on.</li>
</ul>
<p>That's a lot of criteria! But that means we also have a big number of possible combinations, each one creating a potential new database. This is why we have <strong>specialized datastores</strong> like:</p>
<ul>
<li>document</li>
<li>column </li>
<li>key-value</li>
<li>graph </li>
<li>indexing</li>
<li>messaging</li>
<li>and others!</li>
</ul>
<h2 id="stateless-applications"><a class="header" href="#stateless-applications">Stateless applications</a></h2>
<p>This variety of specialized datastore is allowing developers to have multiple datastores as <strong>requirements</strong> for a single infrastructure.</p>
<blockquote>
<p>Alice: &quot;Hey Bob, what do you need for your next project?&quot;</p>
<p>Bob: &quot;Mmmmh, I will need an SQL database and a messaging systems ü§î&quot;.</p>
</blockquote>
<p>Storing data is hard, so we are using them as <strong>durable</strong> strongholds for our data, while making our applications mostly <strong>stateless</strong>.</p>
<p>So, Bob's architecture looks like this:</p>
<pre class="mermaid">flowchart TD
    id1(Bob's stateless applications)
    id2(datastore 1)
    id3(datastore 2)
    
    id1 -- uses --&gt; id2
    id1 -- uses --&gt; id3
</pre>
<h2 id="datastores-architecture"><a class="header" href="#datastores-architecture">Datastore's architecture</a></h2>
<p>We said earlier that there is a lot of criteria to choose a database, but we can narrow to 3: </p>
<ul>
<li>What is the <strong>Query language</strong>,</li>
<li>What is the <strong>data model</strong>,</li>
<li>What is the <strong>Storage Engine</strong>.</li>
</ul>
<p>For example, PostgreSQL is exposing relational data through the SQL language and storing files on a single node. </p>
<p>Let's update the flowchart:</p>
<pre class="mermaid">flowchart TD
    id1(Bob's stateless applications)
    ql1(Query Language 1)
    ql2(Query Language 2)
    dm1(Data Model 1)
    dm2(Data Model 2)
    se1(Storage Engine 1)
    se2(Storage Engine 2)
    
    id1 -- uses --&gt; ql1 
    ql1 -- to access data as --&gt; dm1
    dm1 -- which are stored in --&gt; se1
    id1 -- uses --&gt; ql2
    ql2 -- to access data as --&gt; dm2
    dm2 -- which are stored in --&gt; se2
</pre>
<p>Document databases, column-oriented, row-oriented, JSON, key-value, etc. all make sense in the right context, and often different parts of an application call for different choices. That means we cannot mutualize the Query language and the data models. What's left is the <strong>storage engine</strong>.</p>
<h2 id="sharing-the-storage-engine-"><a class="header" href="#sharing-the-storage-engine-">Sharing the storage engine ü§î</a></h2>
<p>Let's mutualize the storage Engine!</p>
<pre class="mermaid">flowchart TD
    id1(Bob's stateless applications)
    ql1(Query Language 1)
    ql2(Query Language 2)
    dm1(Data Model 1)
    dm2(Data Model 2)
    se(Shared storage Engine)
    
    id1 -- uses --&gt; ql1 
    ql1 -- to access data as --&gt; dm1
    dm1 -- which are stored in --&gt; se
    id1 -- uses --&gt; ql2
    ql2 -- to access data as --&gt; dm2
    dm2 -- which are stored in --&gt; se
</pre>
<p>This design has some great advantages:</p>
<ul>
<li>the storage engine <em>only need to focus</em> on storage,</li>
<li>any components above the storage Engine <strong>has become stateless</strong>.</li>
</ul>
<p>That could work, but if we have put a lot of contraints on the storage engine, let's talk about what we require. </p>
<h2 id="requirements-for-such-a-storage-engine"><a class="header" href="#requirements-for-such-a-storage-engine">Requirements for such a storage engine</a></h2>
<p>So, we know have a storage engines that needs to handle multiple types of data. To be cloud-Native, the storage engine needs to be:</p>
<ul>
<li>fault tolerant,</li>
<li>scalable,</li>
<li>highly available.</li>
</ul>
<p>while providing:</p>
<ul>
<li>strong semantics,</li>
<li>flexible data models.</li>
</ul>
<p>Now the question is: <strong>can we design such a storage engine?</strong> The answer is <strong>yes</strong>, and it is called FoundationDB.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="enter-foundationdb"><a class="header" href="#enter-foundationdb">Enter FoundationDB</a></h1>
<ul>
<li><a href="meet_fdb/enter_fdb.html#foundationdb-as-a-database">FoundationDB as a database</a></li>
<li><a href="meet_fdb/enter_fdb.html#foundationdb-as-a-database-framework">FoundationDB as a database-framework</a></li>
<li><a href="meet_fdb/enter_fdb.html#a-brief-history-of-foundationdb">A brief history of FoundationDB</a></li>
<li><a href="meet_fdb/enter_fdb.html#who-is-using-foundationdb">Who is using FoundationDB?</a></li>
<li><a href="meet_fdb/enter_fdb.html#tldr">TL;DR</a></li>
</ul>
<p>Let's start by quoting the <a href="https://apple.github.io/foundationdb/">official overview</a>:</p>
<blockquote>
<p>FoundationDB is a distributed database designed to handle large volumes of structured data across clusters of commodity servers. It organizes data as an ordered key-value store and employs ACID transactions for all operations. It is especially well-suited for read/write workloads but also has excellent performance for write-intensive workloads.</p>
</blockquote>
<p>FoundationDB is an open-source(Apache V2), distributed key-value store written in Flow, an async-first language that targets C++ specially developed for the database. </p>
<p>Like all key-value stores, it looks like an infinite dictionary/map from programming, allowing you to store key and values in bytes. </p>
<p>Keys are lexicographic order, which means:</p>
<ul>
<li><code>'0'</code> is sorted before <code>'1'</code></li>
<li><code>'apple'</code> is sorted before <code>'banana'</code></li>
<li><code>'apple'</code> is sorted before <code>'apple123'</code></li>
<li>keys starting with <code>'mytable\'</code> are sorted together (e.g. <code>'mytable\row1'</code>, <code>'mytable\row2'</code>, ...)</li>
</ul>
<p>One huge advantage of FDB is that it supports <strong>multi-key strictly serializable transactions</strong>. Let's break-down the words in reverse order:</p>
<ul>
<li><strong>transactions</strong>: All reads and writes in FoundationDB are accomplished using transactions. These transactions are fully ACID (Atomic, Consistent, Isolated, and Durable) and span across multiple machines with high performance.</li>
<li><strong>Serializable</strong>: this means that the outcome of concurrent transaction is equal to a serial execution.</li>
<li><strong>Strictly</strong>: transactions are strictly ordered</li>
<li><strong>Multi-key</strong>: you can write across regions/shards</li>
</ul>
<p>The full list of features is available <a href="https://apple.github.io/foundationdb/features.html">here</a>, and you will also finds a <a href="https://apple.github.io/foundationdb/anti-features.html">anti-features list</a>.</p>
<h2 id="foundationdb-as-a-database"><a class="header" href="#foundationdb-as-a-database">FoundationDB as a database</a></h2>
<p>FoundationDB provides amazing performance on commodity hardware, allowing you to support very heavy loads at low cost. The official <a href="https://apple.github.io/foundationdb/performance.html">performance page</a> is giving us some insights:</p>
<p><img src="https://apple.github.io/foundationdb/_images/scaling.png" alt="fdb_perf" /></p>
<blockquote>
<p>Here, a cluster of commodity hardware scales to 8.2 million operations/sec doing a 90% read and 10% write workload with 16 byte keys and values between 8 and 100 bytes. </p>
</blockquote>
<p>You can expect sub-millisecond performance for small reads, without any tuning.</p>
<p>Beside having huge performance, FoundationDB is  easy to <strong>install, grow, manage and fault tolerant</strong>. It has been running in production for years in companies like Apple or Snowflake. Backing FoundationDB up is an unmatched testing system based on a <strong>deterministic simulation engine</strong> that will be described later in the book.</p>
<h2 id="foundationdb-as-a-database-framework"><a class="header" href="#foundationdb-as-a-database-framework">FoundationDB as a database-framework</a></h2>
<p>For developers, FoundationDB can be seen as a <strong>database-framework</strong>: it decouples its data storage technology from its data model, allowing you to write <strong>&quot;layers&quot;</strong>: stateless applications that will use FoundationDB as their storage.</p>
<pre class="mermaid">flowchart TD
    fdb(FoundationDB)
    l1(Layer 1)
    l2(Layer 2)
    ln(Layer N)
    
    l1 -- uses --&gt; fdb
    l2 -- uses --&gt; fdb
    ln -- uses --&gt; fdb
</pre>
<p>Each layer can expose high level data models. They can be developed as libraries or stateless services. And because of FDB performance, they are easy to scale.</p>
<h2 id="a-brief-history-of-foundationdb"><a class="header" href="#a-brief-history-of-foundationdb">A brief history of FoundationDB</a></h2>
<p>FoundationDB started first as a company in 2009. The FoundationDB Alpha program began in January 2012 and concluded on March 4, 2013 with their public Beta release.</p>
<p>Their 1.0 version was released for general availability on August 20, 2013. On March 24, 2015 it was reported that Apple has acquired the company.</p>
<p>On April 19, 2018, Apple open sourced the software, releasing it under the Apache 2.0 license.</p>
<h2 id="who-is-using-foundationdb"><a class="header" href="#who-is-using-foundationdb">Who is using FoundationDB?</a></h2>
<p>Many companies are using FDB, including:</p>
<ul>
<li><strong>Apple iCloud</strong>: they are the largest users. Billions of logical databases are stored in FDB (one per user per application). You will find more details about this on the Record-layer chapter.</li>
<li><strong>Snowflake</strong> is storing all their metadatas in FDB,</li>
<li><strong>VMWare</strong> Tanzu (Formerly Wavefront),</li>
<li><strong>IBM</strong> (Apache CouchDB),</li>
<li><strong>eBay</strong>,</li>
<li><strong>Epic Games</strong>,</li>
<li>...</li>
</ul>
<h2 id="tldr"><a class="header" href="#tldr">TL;DR</a></h2>
<p>FoundationDB is a scalable, robust, distributed key-value store that you can use as a framework to write your own <del>database</del> layer ü§Ø</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="everything-is-a-key-value"><a class="header" href="#everything-is-a-key-value">Everything is a key-value!</a></h1>
<ul>
<li><a href="meet_fdb/everything_is_kv.html#yugabyte">Yugabyte</a></li>
<li><a href="meet_fdb/everything_is_kv.html#f1-and-spanner-from-google">F1 and Spanner from Google</a></li>
<li><a href="meet_fdb/everything_is_kv.html#tidb--tikv">TiDB / TiKV</a></li>
<li><a href="meet_fdb/everything_is_kv.html#cosmosdb">CosmosDB</a></li>
<li><a href="meet_fdb/everything_is_kv.html#cockroachdb">CockroachDB</a></li>
<li><a href="meet_fdb/everything_is_kv.html#dgraph">Dgraph</a></li>
</ul>
<blockquote>
<p>Ok, so I could store a table-like data in a key-value?</p>
</blockquote>
<p>Yes, this is exactly the idea. It may seem weird at first, but it is a common pattern among new databases. In this section, we will briefly go over some examples.</p>
<h2 id="yugabyte"><a class="header" href="#yugabyte">Yugabyte</a></h2>
<p>From the official <a href="https://docs.yugabyte.com/latest/architecture/layered-architecture/">documentation</a>:</p>
<blockquote>
<p>YugabyteDB architecture follows a layered design. It is comprised of 2 logical layers as shown in the diagram below:</p>
<ul>
<li>
<p>Yugabyte Query Layer</p>
</li>
<li>
<p>DocDB distributed document store</p>
</li>
</ul>
</blockquote>
<p>Information about key encoding format can be found <a href="https://github.com/YugaByte/yugabyte-db/wiki/Low-level-DocDB-key-encoding-format">here</a> and <a href="https://youtu.be/DAFQcYXK2-o?t=1523">here</a>.</p>
<h2 id="f1-and-spanner-from-google"><a class="header" href="#f1-and-spanner-from-google">F1 and Spanner from Google</a></h2>
<p>There is a lot of contents about Google's datastores and their evolution.</p>
<p>At first, they built <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36971.pdf">Megastore</a> on top of BigTable:</p>
<blockquote>
<p>In brief, it provides fully serializable ACID semantics over distant replicas with low enough latencies to support interactive applications.</p>
<p>We use Google‚Äôs Bigtable for scalable fault-tolerant storage within a single datacenter, allowing us to support arbitrary read and write throughput by spreading operations across multiple rows.</p>
</blockquote>
<p>Then, the first version of <a href="https://www.usenix.org/system/files/conference/osdi12/osdi12-final-16.pdf">Spanner</a> appeared:</p>
<blockquote>
<p>Spanner is a scalable, globally-distributed database designed, built, and deployed at Google.</p>
<p>Spanner has evolved from a Bigtable-like versioned key-value store into a temporal multi-version database. Data is stored in schematized semi-relational tables; data is versioned, and each version is automatically timestamped with its commit time</p>
</blockquote>
<p>Then they added <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/41344.pdf">F1</a> on top of Spanner:</p>
<blockquote>
<p>F1 is a fault-tolerant globally-distributed OLTP and OLAP database built at Google as the new storage system for Google‚Äôs AdWords system. It was designed to replace a sharded MySQL implementation that was not able to meet our growing scalability and reliability requirements.</p>
<p>F1 is built on top of Spanner</p>
</blockquote>
<p>And finally, <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/acac3b090a577348a7106d09c051c493298ccb1d.pdf">Spanner itself became an SQL system</a>:</p>
<blockquote>
<p>Google‚Äôs Spanner started out as a key-value store offering multi-row transactions, external consistency, and transparent failover across datacenters. Over the past 7 years it has evolved into a relational database system</p>
</blockquote>
<p>It seems it is still organized as layers:</p>
<blockquote>
<p>Like the lower storage and transactional layers, </p>
</blockquote>
<h2 id="tidb--tikv"><a class="header" href="#tidb--tikv">TiDB / TiKV</a></h2>
<p>In the titanium stack, TiKV is the storage layer for <a href="https://www.vldb.org/pvldb/vol13/p3072-huang.pdf">TiDB</a>:</p>
<blockquote>
<p>It has three core components: a distributed storage layer, a Placement Driver(PD), and a computation engine layer.</p>
<p>The distributed storage layer consists of a row store (TiKV) and a columnar store (TiFlash). Logically, the data stored in TiKV is an ordered key-value map. Each tuple is mapped into a key-value pair. The key is composed of its table ID and row ID, and the value is the actual row data, where the table ID and row ID are unique integers </p>
</blockquote>
<p>The table codec can be found <a href="https://github.com/pingcap/tidb/tree/master/tablecodec">here</a>.</p>
<h2 id="cosmosdb"><a class="header" href="#cosmosdb">CosmosDB</a></h2>
<p>More details can be found <a href="http://muratbuffalo.blogspot.com/2018/08/azure-cosmos-db.html">here</a>:</p>
<blockquote>
<p>Cosmos DB supports and projects multiple data models (documents, graphs, key-value, table, etc.) over a minimalist type system and core data model: the atom-record-sequence (ARS) model.</p>
<p>Container and item resources are further projected as reified resource types for a specific type of API interface. For example, while using document-oriented APIs, container and item resources are projected as collection and document resources respectively.</p>
</blockquote>
<p>The automatic indexing strategy is described <a href="http://www.vldb.org/pvldb/vol8/p1668-shukla.pdf">here</a>.</p>
<h2 id="cockroachdb"><a class="header" href="#cockroachdb">CockroachDB</a></h2>
<p>This old <a href="https://www.cockroachlabs.com/blog/sql-in-cockroachdb-mapping-table-data-to-key-value-storage/">blogpost</a> describes the idea:</p>
<blockquote>
<p>The CockroachDB SQL system is built on top of the internal CockroachDB key-value store and leverages the monolithic sorted key-value map to store all of the SQL table data and indexes.</p>
</blockquote>
<p>The encoding notes can be found <a href="https://github.com/cockroachdb/cockroach/blob/master/docs/tech-notes/encoding.md">here</a>.</p>
<h2 id="dgraph"><a class="header" href="#dgraph">Dgraph</a></h2>
<p>From the official <a href="https://dgraph.io/docs/dgraph-overview/#dgraph-architecture">documentation</a>:</p>
<blockquote>
<p>Dgraph is a single layer in your tech stack, but inside the inner workings of a Dgraph database instance, there are three distinct entities:</p>
<ul>
<li>Badger - Dgraph‚Äôs custom-built key-value store </li>
<li>Ristretto - Dgraph‚Äôs custom-built cache </li>
<li>Dgraph - the methods and algorithms used to parse DQL (and now GraphQL) and act accordingly</li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="correct-and-robust-choose-both"><a class="header" href="#correct-and-robust-choose-both">Correct and robust, choose both</a></h1>
<ul>
<li><a href="meet_fdb/correctess.html#jepsen">Jepsen</a></li>
<li><a href="meet_fdb/correctess.html#flow-programming-language">Flow programming language</a></li>
<li><a href="meet_fdb/correctess.html#simulation-driven-development">Simulation-Driven development</a></li>
<li><a href="meet_fdb/correctess.html#cooperating-with-the-simulation-framework-with-buggify">Cooperating with the simulation framework with Buggify</a></li>
<li><a href="meet_fdb/correctess.html#implications-for-ci">Implications for CI</a></li>
<li><a href="meet_fdb/correctess.html#tldr">TL;DR</a></li>
</ul>
<p>FoundationDB is famously known in the distributed system's community for the simulation framework they developed, unmatched in the industry. In this section, we will go through why FoundationDB is one of the most robust distributed database available.</p>
<h2 id="jepsen"><a class="header" href="#jepsen">Jepsen</a></h2>
<p>First, let's introduce <a href="http://jepsen.io/">Jepsen</a>:</p>
<blockquote>
<p>Jepsen is an effort to improve the safety of distributed databases, queues, consensus systems, etc. We maintain an open source software library for systems testing, as well as blog posts and conference talks exploring particular systems‚Äô failure modes. In each analysis we explore whether the system lives up to its documentation‚Äôs claims, file new bugs, and suggest recommendations for operators.</p>
</blockquote>
<blockquote>
<p>Jepsen pushes vendors to make accurate claims and test their software rigorously, helps users choose databases and queues that fit their needs, and teaches engineers how to evaluate distributed systems correctness for themselves.</p>
</blockquote>
<p>Jepsen is now a standard for testing databases, but there is no FoundationDB analysis:</p>
<p><img src="meet_fdb/img/aphyr.png" alt="aphyr" /></p>
<h2 id="flow-programming-language"><a class="header" href="#flow-programming-language">Flow programming language</a></h2>
<p>Let's dive in the testing part of FoundationDB, starting with Flow. let's quote the <a href="https://apple.github.io/foundationdb/engineering.html">Engineering page</a>:</p>
<blockquote>
<p>FoundationDB began with ambitious goals for both high performance per node and scalability. We knew that to achieve these goals we would face serious engineering challenges that would require tool breakthroughs. We‚Äôd need efficient asynchronous communicating processes like in Erlang or the Async in .NET, but we‚Äôd also need the raw speed, I/O efficiency, and control of C++. To meet these challenges, we developed several new tools, the most important of which is <strong>Flow</strong>, a new programming language that brings actor-based concurrency to C++11.</p>
</blockquote>
<p>Flow is more of a <strong>stateful distributed system framework</strong> than an asynchronous library. It takes a number of highly opinionated stances on how the overall distributed system should be written, and isn‚Äôt trying to be a widely reusable building block.</p>
<blockquote>
<p>Flow adds about 10 keywords to C++11 and is technically a trans-compiler: the Flow compiler reads Flow code and compiles it down to raw C++11, which is then compiled to a native binary with a traditional toolchain.</p>
</blockquote>
<p>Flow was developed before FDB, as stated in this <a href="https://news.ycombinator.com/item?id=5319163">2013's post</a>:</p>
<blockquote>
<p>FoundationDB founder here. Flow sounds crazy. What hubris to think that you need a new programming language for your project? Three years later: Best decision we ever made.</p>
</blockquote>
<blockquote>
<p>We knew this was going to be a long project so we invested heavily in tools at the beginning. The first two weeks of FoundationDB were building this new programming language to give us the speed of C++ with high level tools for actor-model concurrency. But, the real magic is how Flow enables us to use our real code to do deterministic simulations of a cluster in a single thread. We have a white paper upcoming on this.</p>
</blockquote>
<blockquote>
<p>We've had quite a bit of interest in Flow over the years and I've given several talks on it at meetups/conferences. We've always thought about open-sourcing it... It's not as elegant as some other actor-model languages like Scala or Erlang (see: C++) but it's nice and fast at run-time and really helps productivity vs. writing callbacks, etc.</p>
</blockquote>
<blockquote>
<p>(Fun fact: We've only ever found two bugs in Flow. After the first, we decided that we never wanted a bug again in our programming language. So, we built a program in Python that generates random Flow code and independently-executes it to validate Flow's behavior. This fuzz tester found one more bug, and we've never found another.)</p>
</blockquote>
<p>A very good overview of Flow is available <a href="https://apple.github.io/foundationdb/flow.html">here</a> and some details <a href="https://forums.foundationdb.org/t/why-was-flow-developed/1711/3">here</a>.</p>
<h2 id="simulation-driven-development"><a class="header" href="#simulation-driven-development">Simulation-Driven development</a></h2>
<p>One of Flow‚Äôs most important job is enabling <strong>Simulation</strong>:</p>
<blockquote>
<p>We wanted FoundationDB to survive failures of machines, networks, disks, clocks, racks, data centers, file systems, etc., so we created a simulation framework closely tied to Flow. By replacing physical interfaces with shims, replacing the main epoll-based run loop with a time-based simulation, and running multiple logical processes as concurrent Flow Actors, Simulation is able to conduct a deterministic simulation of an entire FoundationDB cluster within a single-thread! Even better, we are able to execute this simulation in a deterministic way, enabling us to reproduce problems and add instrumentation ex post facto. This incredible capability enabled us to build FoundationDB exclusively in simulation for the first 18 months and ensure exceptional fault tolerance long before it sent its first real network packet. For a database with as strong a contract as the FoundationDB, testing is crucial, and over the years we have run the equivalent of a trillion CPU-hours of simulated stress testing.</p>
</blockquote>
<p>A good overview of the simulation can be found <a href="https://apple.github.io/foundationdb/testing.html">here</a>. </p>
<p>You can also have a look at those two awesome talk:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4fFDFbi3toc" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<iframe width="560" height="315" src="https://www.youtube.com/embed/fFSPwJFXVlw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>Simulation has been made possible by combining:</p>
<ul>
<li>Single-threaded pseudo-concurrency,</li>
<li>Simulated implementation of all external communication,</li>
<li>determinism.</li>
</ul>
<p>Here's an example of a <a href="https://github.com/apple/foundationdb/blob/master/tests/slow/SwizzledCycleTest.toml">testfile</a>:</p>
<pre><code class="language-toml">[[test]]
testTitle = 'SwizzledCycleTest'

    # Goal of the test
    [[test.workload]]
    testName = 'Cycle'
    transactionsPerSecond = 5000.0
    testDuration = 30.0
    expectedRate = 0.01

    # What will be done concurrently to prevent the goal

    # random clogging
    [[test.workload]]
    testName = 'RandomClogging'
    testDuration = 30.0
    swizzle = 1

    # reboot machines
    [[test.workload]]
    testName = 'Attrition'
    machinesToKill = 10
    machinesToLeave = 3
    reboot = true
    testDuration = 30.0

    [[test.workload]]
    testName = 'Attrition'
    machinesToKill = 10
    machinesToLeave = 3
    reboot = true
    testDuration = 30.0
    
    # Change configuration to trigger a coordination changes
    [[test.workload]]
    testName = 'ChangeConfig'
    maxDelayBeforeChange = 30.0
    coordinators = 'auto'
</code></pre>
<p>The test is splitted into two parts:</p>
<ul>
<li>
<p><strong>The goal</strong>, for example doing transaction pointing to another with thousands of transactions per sec and there should be only 0.01% of success.</p>
</li>
<li>
<p><strong>What will be done to try to prevent the test to succeed</strong>. In this example it will <strong>at the same time</strong>:</p>
<ul>
<li>do random clogging. Which means that <strong>network connections will be stopped</strong> (preventing actors to send and receive packets). Swizzle flag means that a subset of network connections will be stopped and bring back in reverse order, üò≥</li>
<li>will <strong>poweroff/reboot machines</strong> (attritions) pseudo-randomly while keeping a minimal of three machines, ü§Ø</li>
<li><strong>change configuration</strong>, which means a coordination changes through multi-paxos for the whole cluster. üò±</li>
</ul>
</li>
</ul>
<p>Keep in mind that all these failures will appears <strong>at the same time!</strong> Do you think that your current <strong>datastore has gone through the same test on a daily basis?</strong> <a href="https://github.com/etcd-io/etcd/pull/11308">I think not</a>.</p>
<p>Everything is seed-driven, which means that if a faulty seed is found, you can reproduce the bug locally. For example, if the seed <code>1094093328</code> is in error, you can just run <code>./fdbserver -r simulation -f ./SwizzledCycleTest.toml -b on -s 1094093328</code>:</p>
<script id="asciicast-aYxsjrHRuQLQiHuMVaNWYLAxo" src="https://asciinema.org/a/aYxsjrHRuQLQiHuMVaNWYLAxo.js" async></script>
<p>Everything is deterministic, from the errors, how much time RPCs will take, and even which actor is scheduled.</p>
<h2 id="cooperating-with-the-simulation-framework-with-buggify"><a class="header" href="#cooperating-with-the-simulation-framework-with-buggify">Cooperating with the simulation framework with Buggify</a></h2>
<p>Having a simulation framework is not enough, and one important aspects of the simulation is called Buggify. It is well explained in <a href="https://transactional.blog/simulation/buggify.html">this blogpost</a>:</p>
<blockquote>
<p>A deterministic simulation framework with random fault injection provides a testing framework that can find bugs. However, the question is how quickly? If validating the correctness of a network protocol or storage engine, then network or disk fault injection alone would be sufficient to give a high degree of confidence in correctness. The types of dangerous conditions that the code must correctly handle, such as network instability or disk corruption, exactly match what the simulator directly produces.</p>
<p>How FoundationDB does this is with the BUGGIFY macro. BUGGIFY exists to bias the simulator towards doing dangerous, bug-finding things. It is the main tool that differentiates FDB‚Äôs simulation testing from other black box solutions. Instead of writing FoundationDB and then trying to validated it against a separate blackbox testing solution afterwards, FoundationDB was written to explicitly cooperate with the simulator by instrumenting its code with descriptions of how to cause failures in each component of the system.</p>
<p>BUGGIFY has the following rules:</p>
<ul>
<li>
<p>BUGGIFY only ever evaluates to true when run in simulation.</p>
</li>
<li>
<p>The first time each BUGGIFY use is evaluated, it is either enabled or disabled for the entire simulation run.</p>
</li>
<li>
<p>Enabled uses of BUGGIFY have a 25% chance of evaluating to true (or custom, e.g. BUGGIFY_WITH_PROB(0.001) == 0.1% chance).</p>
</li>
</ul>
</blockquote>
<p><code>BUGGIFY</code> is allowing FDB developers to inject <a href="https://github.com/apple/foundationdb/blob/07e531947765696c3d0e80703967dd5da420fb28/fdbserver/TLogServer.actor.cpp#L1252-L1256">deterministic delays</a>:</p>
<pre><code class="language-cpp">	if (!self-&gt;spillOrder.size()) {
		wait(delay(BUGGIFY ? SERVER_KNOBS-&gt;BUGGIFY_TLOG_STORAGE_MIN_UPDATE_INTERVAL
		                   : SERVER_KNOBS-&gt;TLOG_STORAGE_MIN_UPDATE_INTERVAL,
		           TaskPriority::UpdateStorage));
		return Void();
	}

</code></pre>
<p>Or failures like <a href="https://github.com/apple/foundationdb/blob/main/fdbrpc/FlowTransport.actor.cpp#L1021-L1027">bitsFlip</a> on RPC calls:</p>
<pre><code class="language-cpp">if (g_network-&gt;isSimulated() &amp;&amp;
			g_network-&gt;now() - g_simulator.lastConnectionFailure &gt; g_simulator.connectionFailuresDisableDuration &amp;&amp;
			BUGGIFY_WITH_PROB(0.0001)) {
				g_simulator.lastConnectionFailure = g_network-&gt;now();
				isBuggifyEnabled = true;
				TraceEvent(SevInfo, &quot;BitsFlip&quot;).log();
				int flipBits = 32 - (int)floor(log2(deterministicRandom()-&gt;randomUInt32()));

				uint32_t firstFlipByteLocation = deterministicRandom()-&gt;randomUInt32() % packetLen;
</code></pre>
<h2 id="implications-for-ci"><a class="header" href="#implications-for-ci">Implications for CI</a></h2>
<p>Having such a powerful testing environment means that every FDB developer can concentrate on the code, and CI will try to brute-force your code. This has two major consequences:</p>
<ul>
<li>Typically run 100k simulation tests for each PR before reviewing(500 cores for about two hours)</li>
<li>Critical code require millions of correctness tests.</li>
</ul>
<h2 id="tldr-1"><a class="header" href="#tldr-1">TL;DR</a></h2>
<blockquote>
<p>&quot;Simulation‚Äôs success has surpassed our expectation and has been vital to our engineering team.&quot;</p>
<p>&quot;It seems unlikely that we would have been able to build FoundationDB without this technology.&quot;</p>
</blockquote>
<p>We can also quote <a href="https://youtu.be/fFSPwJFXVlw">Will Wilson</a>:</p>
<blockquote>
<p>The reason why people write tests is because human beings are astonishingly bad at thinking through all the possible branches of control flow that a program could take.</p>
<p>But that very fact means that we're unable to write tests to cover all the things that we actually need to cover, like because if we could, if we were smart enough, or had the right kind of brain to write all the tests we needed to write, then we would have just written the code correctly in the first place.</p>
<p>I think this is like really scary and really true, and the implications is that tests can be useful for turning up regressions, but almost completely useless for telling you about unknown unknowns.</p>
<p>I think this is the real secret sauce behind what FoundationDB did, it's not so much the deterministic simulation although that was a very important part of it. It was that whenever we had a new piece of functionality, we didn't say &quot;how can I write some tests to cover this?&quot;. It was more like &quot;how can I write a system that will forever be generating new and interesting tests?&quot;</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installing-foundationdb"><a class="header" href="#installing-foundationdb">Installing FoundationDB</a></h1>
<ul>
<li><a href="getting_started/installing-fdb.html#client-or-server">Client or server?</a>
<ul>
<li><a href="getting_started/installing-fdb.html#clients">Clients</a></li>
<li><a href="getting_started/installing-fdb.html#server">Server</a></li>
</ul>
</li>
<li><a href="getting_started/installing-fdb.html#the-cluster-file">The cluster file</a></li>
<li><a href="getting_started/installing-fdb.html#-wire-protocol">‚ö†Ô∏è Wire protocol</a></li>
</ul>
<p>The official documentation has plenty of docs on how to install FoundationDB:</p>
<ul>
<li><a href="https://apple.github.io/foundationdb/getting-started-linux.html">Getting Started on Linux</a></li>
<li><a href="https://apple.github.io/foundationdb/getting-started-mac.html">Getting Started on macOS</a></li>
</ul>
<h2 id="client-or-server"><a class="header" href="#client-or-server">Client or server?</a></h2>
<p>In the <a href="https://apple.github.io/foundationdb/downloads.html">Downloads page</a>, you will find reference to two archives:</p>
<ul>
<li>clients</li>
<li>server</li>
</ul>
<h3 id="clients"><a class="header" href="#clients">Clients</a></h3>
<p>The clients package is required by all bindings(i.e. programming libraries). These are needed files for all bindings:</p>
<ul>
<li><code>/usr/lib/libfdb_c.so</code></li>
<li><code>/usr/include/foundationdb/fdb_c.h</code></li>
<li><code>/usr/include/foundationdb/fdb_c_options.g.h</code></li>
</ul>
<p>You will also find different binaries:</p>
<ul>
<li>dr_agent</li>
<li>fdbbackup</li>
<li>fdbcli</li>
<li>fdbdr</li>
<li>fdbrestore</li>
</ul>
<h3 id="server"><a class="header" href="#server">Server</a></h3>
<p>The server package is holding FDB's binaries:</p>
<ul>
<li>fdbmonitor</li>
<li>fdbserver</li>
</ul>
<p>And a default configuration file for <code>fdbmonitor</code> located at <code>/etc/foundationdb/foundationdb.conf</code>. <code>fdbserver</code> is the main binary, and <code>fdbmonitor</code> is simply a wrapper on top of <code>fdbserver</code>.</p>
<h2 id="the-cluster-file"><a class="header" href="#the-cluster-file">The cluster file</a></h2>
<p>Both packages will install a default <a href="https://apple.github.io/foundationdb/administration.html#cluster-files">cluster file</a>:</p>
<blockquote>
<p>FoundationDB servers and clients use a cluster file (usually named <code>fdb.cluster</code>) to connect to a cluster. The contents of the cluster file are the same for all processes that connect to the cluster. An <code>fdb.cluster</code> file is created automatically when you install a FoundationDB server and updated automatically when you <a href="https://apple.github.io/foundationdb/configuration.html#configuration-choosing-coordination-servers">change coordination servers</a>. To connect to a cluster from a client machine, you will need access to a copy of the cluster file used by the servers in the cluster.</p>
</blockquote>
<h2 id="-wire-protocol"><a class="header" href="#-wire-protocol">‚ö†Ô∏è Wire protocol</a></h2>
<p>FoundationDB's wire protocol is not compatible between minors releases, i.e. client version 6.2 will <strong>not</strong> be able to communicate with 6.3.X, 6.1.X, and all versions different from 6.3.X.</p>
<p>On the bindings-side, the client will be <a href="https://forums.foundationdb.org/t/detecting-a-version-mismatch/3055/2">stalling</a>. On the server's logs,  you would see events like <code>ConnectionRejected</code> with a reason <code>IncompatibleProtocolVersion</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="playing-with-fdbcli"><a class="header" href="#playing-with-fdbcli">Playing with fdbcli</a></h1>
<ul>
<li><a href="getting_started/fdbcli.html#setting-up-foundationdb-with-docker">Setting up FoundationDB with Docker</a></li>
<li><a href="getting_started/fdbcli.html#fdbcli"><code>fdbcli</code>?</a></li>
<li><a href="getting_started/fdbcli.html#start-the-shell">Start the shell</a></li>
<li><a href="getting_started/fdbcli.html#useful-commands">Useful commands</a>
<ul>
<li><a href="getting_started/fdbcli.html#status">Status</a></li>
<li><a href="getting_started/fdbcli.html#create-a-new-database">Create a new database</a></li>
<li><a href="getting_started/fdbcli.html#insert-keys">Insert keys</a></li>
<li><a href="getting_started/fdbcli.html#scan-keys">scan keys</a></li>
<li><a href="getting_started/fdbcli.html#help">Help</a></li>
</ul>
</li>
</ul>
<h2 id="setting-up-foundationdb-with-docker"><a class="header" href="#setting-up-foundationdb-with-docker">Setting up FoundationDB with Docker</a></h2>
<pre><code class="language-shell">docker run --name fdb -d -p 4500:4500 --rm foundationdb/foundationdb:6.3.23
</code></pre>
<h2 id="fdbcli"><a class="header" href="#fdbcli"><code>fdbcli</code>?</a></h2>
<p><code>fdbcli</code> is a command-line interface that can be used to administrate your FDB cluster.</p>
<h2 id="start-the-shell"><a class="header" href="#start-the-shell">Start the shell</a></h2>
<pre><code class="language-shell">docker exec -ti fdb fdbcli

docker exec -ti fdb fdbcli                                                 
Using cluster file `/var/fdb/fdb.cluster'.

The database is unavailable; type `status' for more information.

Welcome to the fdbcli. For help, type `help'.
</code></pre>
<h2 id="useful-commands"><a class="header" href="#useful-commands">Useful commands</a></h2>
<h3 id="status"><a class="header" href="#status">Status</a></h3>
<p><code>status</code> is one of the most useful command. It will display a human-readable report:</p>
<pre><code class="language-shell">fdb&gt; status

Using cluster file `/var/fdb/fdb.cluster'.

The coordinator(s) have no record of this database. Either the coordinator
addresses are incorrect, the coordination state on those machines is missing, or
no database has been created.

  172.17.0.2:4500  (reachable)

Unable to locate the data distributor worker.

Unable to locate the ratekeeper worker.
</code></pre>
<h3 id="create-a-new-database"><a class="header" href="#create-a-new-database">Create a new database</a></h3>
<p>As our container is brand-new, we need to create a database.</p>
<pre><code class="language-shell">fdb&gt; configure new single memory
Database created
</code></pre>
<p>A few elements to notes:</p>
<ul>
<li>running this will nuke your database,</li>
<li><code>single</code> is the <a href="https://apple.github.io/foundationdb/configuration.html#choosing-a-redundancy-mode">redundancy mode</a>,</li>
<li><code>memory</code> is the <a href="https://apple.github.io/foundationdb/configuration.html#configuring-the-storage-subsystem">storage subsystem</a>.</li>
</ul>
<p>Then we can run the <code>status</code> command:</p>
<pre><code class="language-shell">fdb&gt; help status

status [minimal|details|json]

Get the status of a FoundationDB cluster.

If the cluster is down, this command will print a diagnostic which may be useful
in figuring out what is wrong. If the cluster is running, this command will
print cluster statistics.

Specifying `minimal' will provide a minimal description of the status of your
database.

Specifying `details' will provide load information for individual workers.

Specifying `json' will provide status information in a machine readable JSON
format.
</code></pre>
<pre><code class="language-shell">fdb&gt; status

Using cluster file `/var/fdb/fdb.cluster'.

Configuration:
  Redundancy mode        - single
  Storage engine         - memory-2
  Coordinators           - 1
  Usable Regions         - 1

Cluster:
  FoundationDB processes - 1
  Zones                  - 1
  Machines               - 1
  Memory availability    - 8.0 GB per process on machine with least available
  Fault Tolerance        - 0 machines
  Server time            - 02/10/22 12:57:50

Data:
  Replication health     - Healthy
  Moving data            - 0.000 GB
  Sum of key-value sizes - 0 MB
  Disk space used        - 105 MB

Operating space:
  Storage server         - 1.0 GB free on most full server
  Log server             - 1555.9 GB free on most full server

Workload:
  Read rate              - 7 Hz
  Write rate             - 0 Hz
  Transactions started   - 3 Hz
  Transactions committed - 0 Hz
  Conflict rate          - 0 Hz

Backup and DR:
  Running backups        - 0
  Running DRs            - 0

Client time: 02/10/22 12:57:50
</code></pre>
<h3 id="insert-keys"><a class="header" href="#insert-keys">Insert keys</a></h3>
<pre><code class="language-shell">fdb&gt; help writemode 

writemode &lt;on|off&gt;

Enables or disables sets and clears.

Setting or clearing keys from the CLI is not recommended.
</code></pre>
<pre><code class="language-shell">fdb&gt; help set

set &lt;KEY&gt; &lt;VALUE&gt;

Set a value for a given key.

If KEY is not already present in the database, it will be created.

For information on escaping keys and values, type `help escaping'.
</code></pre>
<pre><code class="language-shell"># we first need to set writemode

fdb&gt; writemode on
fdb&gt; set hello world
Committed (1442988082)
</code></pre>
<p><code>1442988082</code> is the commitVersion or versionStamp.</p>
<h3 id="scan-keys"><a class="header" href="#scan-keys">scan keys</a></h3>
<pre><code class="language-shell">fdb&gt; help getrange

getrange &lt;BEGINKEY&gt; [ENDKEY] [LIMIT]

Fetch key/value pairs in a range of keys.

Displays up to LIMIT keys and values for keys between BEGINKEY (inclusive) and
ENDKEY (exclusive). If ENDKEY is omitted, then the range will include all keys
starting with BEGINKEY. LIMIT defaults to 25 if omitted.

For information on escaping keys, type `help escaping'
</code></pre>
<pre><code class="language-shell">fdb&gt; getrange \x00 \xfe 10

Range limited to 10 keys
`hello' is `world'
</code></pre>
<h3 id="help"><a class="header" href="#help">Help</a></h3>
<pre><code class="language-shell">fdb&gt; help

List of commands:

 advanceversion:
      Force the cluster to recover at the specified version
 begin:
      begin a new transaction
 clear:
      clear a key from the database
 clearrange:
      clear a range of keys from the database
 commit:
      commit the current transaction
 configure:
      change the database configuration
 consistencycheck:
      permits or prevents consistency checking
 coordinators:
      change cluster coordinators or description
 exclude:
      exclude servers from the database
 exit:
      exit the CLI
 fileconfigure:
      change the database configuration from a file
 force_recovery_with_data_loss:
      Force the database to recover into DCID
 get:
      fetch the value for a given key
 getrange:
      fetch key/value pairs in a range of keys
 getrangekeys:
      fetch keys in a range of keys
 getversion:
      Fetch the current read version
 help:
      get help about a topic or command
 include:
      permit previously-excluded servers to rejoin the database
 kill:
      attempts to kill one or more processes in the cluster
 lock:
      lock the database with a randomly generated lockUID
 maintenance:
      mark a zone for maintenance
 option:
      enables or disables an option
 profile:
      namespace for all the profiling-related commands.
 reset:
      reset the current transaction
 rollback:
      rolls back the current transaction
 set:
      set a value for a given key
 setclass:
      change the class of a process
 sleep:
      sleep for a period of time
 status:
      get the status of a FoundationDB cluster
 suspend:
      attempts to suspend one or more processes in the cluster
 throttle:
      view and control throttled tags
 triggerddteaminfolog:
      trigger the data distributor teams logging
 unlock:
      unlock the database with the provided lockUID
 writemode:
      enables or disables sets and clears

For information on a specific command, type `help &lt;command&gt;'.
For information on escaping keys and values, type `help escaping'.
For information on available options, type `help options'.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="crafting-row-keys"><a class="header" href="#crafting-row-keys">Crafting row keys</a></h1>
<ul>
<li><a href="develop_layer/crafting-row-keys.html#row-key">Row key?</a></li>
<li><a href="develop_layer/crafting-row-keys.html#hand-crafting-row-keys">Hand-crafting row keys</a></li>
<li><a href="develop_layer/crafting-row-keys.html#fdbs-abstractions-and-helpers">FDB's abstractions and helpers</a>
<ul>
<li><a href="develop_layer/crafting-row-keys.html#tuple">Tuple</a></li>
<li><a href="develop_layer/crafting-row-keys.html#subspace">Subspace</a></li>
<li><a href="develop_layer/crafting-row-keys.html#directory">Directory</a></li>
</ul>
</li>
</ul>
<h2 id="row-key"><a class="header" href="#row-key">Row key?</a></h2>
<p>When you are using a key/value store, the design of the <code>row key</code> is extremely important, as this will define how well:</p>
<ul>
<li>your scans will be optimized,</li>
<li>your puts will be spread,</li>
<li>you will avoid <code>hot-spotting</code> a shard/region.</li>
</ul>
<p>If you need more information on <code>row keys</code>, I recommend going through these links before moving on:</p>
<ul>
<li><a href="https://cloud.google.com/bigtable/docs/schema-design">&quot;Designing your schema&quot; BigTable documentation</a></li>
<li><a href="https://hbase.apache.org/book.html#rowkey.design">&quot;Rowkey Design&quot; HBase documentation</a></li>
</ul>
<h2 id="hand-crafting-row-keys"><a class="header" href="#hand-crafting-row-keys">Hand-crafting row keys</a></h2>
<p>Most of the time, you will need to craft the <code>row key</code> &quot;by hand&quot;, like this for <a href="https://github.com/senx/warp10-platform/blob/879734d7f63791b487f3e535cd79ac4c23e99377/warp10/src/main/java/io/warp10/continuum/store/Store.java#L1215-L1222">an HBase's app</a>:</p>
<pre><code class="language-java">// Prefix + classId + labelsId + timestamp
// 128 bits
byte[] rowkey = new byte[Constants.HBASE_RAW_DATA_KEY_PREFIX.length + 8 + 8 + 8];

System.arraycopy(Constants.HBASE_RAW_DATA_KEY_PREFIX, 0, rowkey, 0, Constants.HBASE_RAW_DATA_KEY_PREFIX.length);
// Copy classId/labelsId
System.arraycopy(Longs.toByteArray(msg.getClassId()), 0, rowkey, Constants.HBASE_RAW_DATA_KEY_PREFIX.length, 8);
System.arraycopy(Longs.toByteArray(msg.getLabelsId()), 0, rowkey, Constants.HBASE_RAW_DATA_KEY_PREFIX.length + 8, 8);
</code></pre>
<p>Or maybe you will wrap things in a function <a href="https://github.com/pingcap/tidb/blob/ef57bdbbb04f60a8be744060a99207e08a37514a/tablecodec/tablecodec.go#L80-L86">like this in Go</a>:</p>
<pre><code class="language-go">// EncodeRowKey encodes the table id and record handle into a kv.Key
func EncodeRowKey(tableID int64, encodedHandle []byte) kv.Key {
	buf := make([]byte, 0, prefixLen+len(encodedHandle))
	buf = appendTableRecordPrefix(buf, tableID)
	buf = append(buf, encodedHandle...)
	return buf
}
</code></pre>
<p>Each time, you need to wrap the complexity of converting your objects to a row-key, by creating a buffer and write stuff in it.</p>
<p>In our Java example, there is an interesting comment:</p>
<pre><code class="language-java">// Prefix + classId + labelsId + timestamp
</code></pre>
<p>If we are replacing some characters, we are not really far from:</p>
<pre><code class="language-java">// (Prefix, classId, labelsId, timestamp)
</code></pre>
<p>Which looks like a <code>Tuple</code>(a collection of values of different types) and this is what FoundationDB is using as an abstraction to create keys üòç</p>
<h2 id="fdbs-abstractions-and-helpers"><a class="header" href="#fdbs-abstractions-and-helpers">FDB's abstractions and helpers</a></h2>
<h3 id="tuple"><a class="header" href="#tuple">Tuple</a></h3>
<p>Instead of crafting bytes by hand, we are <code>packing</code> a Tuple:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// create a Tuple&lt;String, i64&gt; with (&quot;tenant-42&quot;, 1)
let tuple = (String::from(&quot;tenant-42&quot;), 1);

// and compute a row-key from the Tuple
let row_key = foundationdb::tuple::pack::&lt;(String, i64)&gt;(&amp;tuple);
<span class="boring">}
</span></code></pre></pre>
<p>The generated row-key will be readable from any bindings, as it's construction is standardized. Let's print it:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// and print-it in hexa
println!(&quot;{:#04X?}&quot;, row_key);
<span class="boring">}
</span></code></pre></pre>
<pre><code class="language-log">// can be verified with https://www.utf8-chartable.de/unicode-utf8-table.pl
[
    0x02,
    0x74, // t
    0x65, // e 
    0x6E, // n
    0x61, // a
    0x6E, // n
    0x74, // t
    0x2D, // -
    0x31, // 1
    0x00, 
    0x15,
    0x2A, // 42
]
</code></pre>
<p>As you can see, <code>pack</code> added some extra-characters. There are used to recognized the next type, a bit like when you are encoding/decoding some wire protocols. You can find the relevant documentation <a href="https://github.com/apple/foundationdb/blob/master/design/tuple.md">here</a>.</p>
<p>Having this kind of standard means that we can easily decompose/<code>unpack</code> it:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// retrieve the user and the magic number In a Tuple (String, i64)
let from_row_key = foundationdb::tuple::unpack::&lt;(String, i64)&gt;(&amp;row_key)?;

println!(&quot;user='{}', magic_number={}&quot;, from_row_key.0, from_row_key.1);
// user='tenant-42', magic_number=42
<span class="boring">}
</span></code></pre></pre>
<p>Now that we saw <code>Tuples</code>, let's dig in the next abstraction: <code>subspaces</code></p>
<h3 id="subspace"><a class="header" href="#subspace">Subspace</a></h3>
<p>When you are working with key-values store, we are often playing with what we call <code>keyspaces</code>, by dedicating a portion of the key to an usage, like this for example:</p>
<pre><code class="language-text">/users/tenant-1/...
/users/tenant-2/...
/users/tenant-3/...
</code></pre>
<p>Here, <code>/users/tenant-1/</code> can be view like a prefix where we will put all the relevant keys. Instead of passing a simple prefix, FoundationDB is offering a dedicated structure called a <code>Subspace</code>:</p>
<blockquote>
<p>A Subspace represents a well-defined region of keyspace in a FoundationDB database</p>
</blockquote>
<blockquote>
<p>It provides a convenient way to use FoundationDB tuples to define namespaces for different categories of data. The namespace is specified by a prefix tuple which is prepended to all tuples packed by the subspace. When unpacking a key with the subspace, the prefix tuple will be removed from the result.</p>
</blockquote>
<p>As you can see, the <code>Subspace</code> is heavily relying on FoundationDB's tuples, as we can <code>pack</code> and <code>unpack</code> it.</p>
<blockquote>
<p>As a best practice, API clients should use at least one subspace for application data.</p>
</blockquote>
<p>Well, as we have now the tools to handle keyspaces easily, it is now futile to craft keys by hand üôÉ Let's create a subspace!</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>// create a subspace from the Tuple (&quot;tenant-1&quot;, 42)
let subspace = Subspace::from((String::from(&quot;tenant-1&quot;), 42));

// let's print the range
println!(&quot;start: {:#04X?}\n end: {:#04X?}&quot;, subspace.range().0, subspace.range().1);
<span class="boring">}
</span></code></pre></pre>
<p>We can see observe this:</p>
<pre><code class="language-log">// can be verified with https://www.utf8-chartable.de/unicode-utf8-table.pl
start: [
    0x02,
    0x74, // t
    0x65, // e 
    0x6E, // n
    0x61, // a
    0x6E, // n
    0x74, // t
    0x2D, // -
    0x31, // 1
    0x00, 
    0x15,
    0x2A, // 42
    0x00,
    0x00, // smallest possible byte
]
end: [
    0x02,
    0x74, // t
    0x65, // e 
    0x6E, // n
    0x61, // a
    0x6E, // n
    0x74, // t
    0x2D, // -
    0x31, // 1
    0x00, 
    0x15,
    0x2A, // 42
    0x00,
    0xFF, // biggest possible byte
]
</code></pre>
<p>Which make sens, if we take <code>(&quot;tenant-1&quot;, 42)</code> as a prefix, then the range for this subspace will be between <code>(&quot;tenant-1&quot;, 42, 0x00)</code> and <code>(&quot;tenant-1&quot;, 42, 0xFF)</code></p>
<h3 id="directory"><a class="header" href="#directory">Directory</a></h3>
<p>Now that we know our way around <code>Tuples</code> and <code>Subspaces</code>, we can now talk about what I'm working on, which is the <code>Directory</code>. Let's have a look at the relevant <a href="https://apple.github.io/foundationdb/developer-guide.html#directories">documentation</a>:</p>
<blockquote>
<p>FoundationDB provides directories (available in each language binding) as a tool for managing related subspaces.</p>
</blockquote>
<blockquote>
<p>Directories are a recommended approach for administering applications. Each application should create or open at least one directory to manage its subspaces.</p>
</blockquote>
<p>Okay, let's see the API in Go:</p>
<pre><code class="language-go">subspace, err := directory.CreateOrOpen(db, []string{&quot;application&quot;, &quot;my-app&quot;, &quot;tenant&quot;, &quot;tenant-42&quot;}, nil)
if err != nil {
	log.Fatal(err)
}

fmt.Printf(&quot;%+v\n&quot;, subspace.Bytes())
// [21 18]
</code></pre>
<p>We can see that we have a shorter subspace! The <code>directory</code> allows you to generate some integer that will be bind to a path, like here <code>&quot;application&quot;, &quot;my-app&quot;, &quot;tenant&quot;, &quot;tenant-42&quot;</code>.</p>
<p>There are two advantages to this:</p>
<ul>
<li>shorter keys,</li>
<li>cheap metadata operations like <code>List</code> or <code>Move</code>:</li>
</ul>
<pre><code class="language-go">// list all tenant in &quot;application&quot;, &quot;my-app&quot;:
tenants, err := directory.List(db, []string{&quot;application&quot;, &quot;my-app&quot;, &quot;tenant&quot;})
if err != nil {
	log.Fatal(err)
}
fmt.Printf(&quot;%+v\n&quot;, tenants)
// [tenant-42]

// renaming 'tenant-42' in 'tenant-142'
// This will NOT move the data, only the metadata is modified
directorySubspace, err = directory.Move(db, 
	[]string{&quot;application&quot;, &quot;my-app&quot;, &quot;tenant&quot;, &quot;tenant-42&quot;},  // old path
	[]string{&quot;application&quot;, &quot;my-app&quot;, &quot;tenant&quot;, &quot;tenant-142&quot;}) // new path
if err != nil {
	log.Fatal(err)
}
fmt.Printf(&quot;%+v\n&quot;, directorySubspace.Bytes())
// still [21 18]
</code></pre>
<p>The returned object is actually a <code>DirectorySubspace</code>, which implements both <code>Directory</code> and <code>Subspace</code>, which means that you can use it to recreate many directories and subspaces at will üëå</p>
<blockquote>
<p>If you are wondering about how this integer is generated, I recommend going through this awesome blogpost on <a href="https://activesphere.com/blog/2018/08/05/high-contention-allocator">how high contention allocator works in FoundationDB.</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tips-and-tricks"><a class="header" href="#tips-and-tricks">Tips and tricks</a></h1>
<ul>
<li><a href="develop_layer/tips.html#about-the-run-method">About the <code>run</code> method</a></li>
<li><a href="develop_layer/tips.html#transaction-priority">Transaction priority</a></li>
<li><a href="develop_layer/tips.html#use-transaction-tagging">Use transaction Tagging</a></li>
<li><a href="develop_layer/tips.html#the-metadataversion">The <code>metadataVersion</code></a></li>
<li><a href="develop_layer/tips.html#the-timekeeper">The TimeKeeper</a></li>
<li><a href="develop_layer/tips.html#special-keys">Special keys</a></li>
</ul>
<p>Here's a few tips and tricks that should help you develop a production-ready layer.</p>
<h2 id="about-the-run-method"><a class="header" href="#about-the-run-method">About the <code>run</code> method</a></h2>
<p>Most bindings are offering a <code>run</code> method, that is taking a closure, like this in <a href="https://apple.github.io/foundationdb/javadoc/com/apple/foundationdb/Database.html#run(java.util.function.Function)">Java</a>.</p>
<p>You should use the <code>run</code> method on your bindings, <strong>BUT</strong> you must add some transactionOptions to avoid blocking forever:</p>
<ul>
<li><strong>Timeout</strong> Set a timeout in milliseconds which, when elapsed, will cause the transaction automatically to be cancelled.</li>
<li><strong>RetryLimit</strong> Set a maximum number of retries</li>
</ul>
<p>it is safe and legal to set these options at the first line of your <code>run</code> closure.</p>
<h2 id="transaction-priority"><a class="header" href="#transaction-priority">Transaction priority</a></h2>
<p>There is 3 transaction priority in FDB:</p>
<ul>
<li><strong>Default</strong>,</li>
<li><strong>Batch</strong> Specifies that this transaction should be treated as low priority and that default priority transactions will be processed first. Useful for doing batch work simultaneously with latency-sensitive work</li>
<li><strong>SystemImmediate</strong> Specifies that this transaction should be treated as highest priority and that lower priority transactions should block behind this one. Use is discouraged outside of low-level tools.</li>
</ul>
<h2 id="use-transaction-tagging"><a class="header" href="#use-transaction-tagging">Use transaction Tagging</a></h2>
<blockquote>
<p>FoundationDB provides the ability to add arbitrary byte-string tags to transactions. The cluster can be configured to limit the rate of transactions with certain tags, either automatically in response to tags that are very busy, or manually using the throttle command in fdbcli.</p>
</blockquote>
<p>More info can be found <a href="https://apple.github.io/foundationdb/transaction-tagging.html">here</a>.</p>
<h2 id="the-metadataversion"><a class="header" href="#the-metadataversion">The <code>metadataVersion</code></a></h2>
<p>The metadata version key <code>\xFF/metadataVersion</code> is a key intended to help layers deal with hot keys. The value of this key is sent to clients along with the read version from the proxy, so a client can read its value without communicating with a storage server.</p>
<p>It is useful to implement some caching-strategy on a layer. More info on how to use the metadataVersion key can be found <a href="https://forums.foundationdb.org/t/sharing-the-metadataversionkey-for-multiple-tenants/1659">here</a>.</p>
<p>‚ö†Ô∏è In a transaction, if you update the \xff/metadataVersion key, and then attempt to read it again, I get a ‚ÄúRead or wrote an unreadable key‚Äù error (1036) when trying to read again. Context can be found <a href="https://forums.foundationdb.org/t/cannot-commit-transaction-that-reads-the-metadataversion-key-after-changing-it/1833">here</a></p>
<h2 id="the-timekeeper"><a class="header" href="#the-timekeeper">The TimeKeeper</a></h2>
<p><code>Cluster Controller</code> actor is keeping a map of read version to system clock time, updated every second. Can be accessible by scanning the <code>\xFF\x02/timeKeeper/map/</code>. More info <a href="https://forums.foundationdb.org/t/approximating-a-global-clock-for-a-watchdog-timer-using-versionstamps-readversions-or-the-timekeeper/477">here</a></p>
<h2 id="special-keys"><a class="header" href="#special-keys">Special keys</a></h2>
<blockquote>
<p>Keys starting with the bytes \xff\xff are called ‚Äúspecial‚Äù keys, and they are materialized when read. \xff\xff/status/json is an example of a special key.</p>
</blockquote>
<p>More info can be found <a href="https://apple.github.io/foundationdb/special-keys.html">here</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
