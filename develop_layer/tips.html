<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tips - the FoundationDB Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <script defer data-domain="pierrez.github.io/fdb-book" src="https://plausible.io/js/plausible.js"></script>                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">the FoundationDB Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PierreZ/fdb-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="best-practices-and-pitfalls"><a class="header" href="#best-practices-and-pitfalls">Best Practices and Pitfalls</a></h1>
<p>This chapter provides a collection of best practices, advanced techniques, and common pitfalls to help you build robust, production-ready layers on FoundationDB.</p>
<ul>
<li><a href="#transaction-management">Transaction Management</a>
<ul>
<li><a href="#use-timeouts-and-retry-limits">Use Timeouts and Retry Limits</a></li>
<li><a href="#set-transaction-priority">Set Transaction Priority</a></li>
</ul>
</li>
<li><a href="#observability">Observability</a>
<ul>
<li><a href="#tag-your-transactions">Tag Your Transactions</a></li>
<li><a href="#enable-client-trace-logs">Enable Client Trace Logs</a></li>
</ul>
</li>
<li><a href="#advanced-techniques">Advanced Techniques</a>
<ul>
<li><a href="#the-metadataversion-key">The <code>metadataVersion</code> Key</a></li>
<li><a href="#the-timekeeper">The <code>TimeKeeper</code></a></li>
<li><a href="#special-keys">Special Keys</a></li>
</ul>
</li>
<li><a href="#common-pitfalls-the-directory-layer">Common Pitfalls: The Directory Layer</a></li>
</ul>
<h2 id="transaction-management"><a class="header" href="#transaction-management">Transaction Management</a></h2>
<h3 id="use-timeouts-and-retry-limits"><a class="header" href="#use-timeouts-and-retry-limits">Use Timeouts and Retry Limits</a></h3>
<p>Most language bindings provide a <code>run</code> or <code>transact</code> method that automatically handles the retry loop for you. However, to prevent transactions from running indefinitely, it is critical to configure two options:</p>
<ul>
<li><strong>Timeout:</strong> Set a timeout in milliseconds. If the transaction takes longer than this to commit, it will be automatically cancelled. This is a crucial backstop for preventing stuck application threads.</li>
<li><strong>Retry Limit:</strong> Set a maximum number of retries. This prevents a transaction from retrying endlessly in the case of a persistent conflict or a live-lock scenario.</li>
</ul>
<p>These options should be set on every transaction to ensure your application remains stable under load.</p>
<h3 id="set-transaction-priority"><a class="header" href="#set-transaction-priority">Set Transaction Priority</a></h3>
<p>FoundationDB supports transaction priorities to help manage workloads.</p>
<ul>
<li><strong>Default:</strong> The standard priority for most latency-sensitive, user-facing operations.</li>
<li><strong>Batch:</strong> A lower priority for background work, such as data cleanup or analytics. Batch priority transactions will yield to default priority transactions, ensuring that they don't interfere with your main application workload.</li>
<li><strong>System Immediate:</strong> The highest priority, which can block other transactions. Its use is discouraged outside of low-level administrative tools.</li>
</ul>
<h2 id="observability"><a class="header" href="#observability">Observability</a></h2>
<h3 id="tag-your-transactions"><a class="header" href="#tag-your-transactions">Tag Your Transactions</a></h3>
<p>FoundationDB allows you to add a byte-string <strong>tag</strong> to any transaction. This is an invaluable tool for observability and performance management. You can use tags to identify different types of workloads (e.g., <code>user_signup</code>, <code>post_comment</code>). The <code>fdbcli</code> tool can then be used to monitor the rate of transactions with specific tags and even throttle them if they are causing excessive load.</p>
<p>See the official documentation on <a href="https://apple.github.io/foundationdb/transaction-tagging.html">Transaction Tagging</a> for more details.</p>
<h3 id="enable-client-trace-logs"><a class="header" href="#enable-client-trace-logs">Enable Client Trace Logs</a></h3>
<p>By default, clients do not generate detailed trace logs. To debug performance issues, you can enable them by setting the <code>TraceEnable</code> database option. You can then add a <code>DebugTransactionIdentifier</code> to a specific transaction and set the <code>LogTransaction</code> option to get detailed, low-level logs about its execution, including all keys and values read and written.</p>
<h2 id="advanced-techniques"><a class="header" href="#advanced-techniques">Advanced Techniques</a></h2>
<h3 id="the-metadataversion-key"><a class="header" href="#the-metadataversion-key">The <code>metadataVersion</code> Key</a></h3>
<p>The special key <code>\xFF/metadataVersion</code> is a cluster-wide version counter that can be used to implement client-side caching. Its value is sent to clients with every read version, so reading it does not require a round-trip to a storage server. A layer can watch this key to know when to invalidate a local cache.</p>
<p><strong>Note:</strong> If you write to the <code>metadataVersion</code> key, you cannot read it again in the same transaction.</p>
<h3 id="the-timekeeper"><a class="header" href="#the-timekeeper">The <code>TimeKeeper</code></a></h3>
<p>The <code>Cluster Controller</code> maintains a map of recent read versions to wall-clock times. This can be accessed by scanning the key range beginning with <code>\xFF\x02/timeKeeper/map/</code>. This can be useful for approximating a global clock.</p>
<h3 id="special-keys"><a class="header" href="#special-keys">Special Keys</a></h3>
<p>Keys prefixed with <code>\xFF\xFF</code> are “special” keys that are materialized on-demand when read. The most common example is <code>\xFF\xFF/status/json</code>, which returns a JSON document containing the cluster's status.</p>
<p>See the official documentation on <a href="https://apple.github.io/foundationdb/special-keys.html">Special Keys</a> for more details.</p>
<h2 id="common-pitfalls-the-directory-layer"><a class="header" href="#common-pitfalls-the-directory-layer">Common Pitfalls: The Directory Layer</a></h2>
<p>The Directory Layer is a powerful tool, but it has several sharp edges that developers must be aware of:</p>
<ul>
<li><strong>Concurrent Mutations:</strong> Modifying the same directory (e.g., creating two different subdirectories within it) in multiple, concurrent transactions is not safe and can lead to corruption.</li>
<li><strong>Metadata Hotspots:</strong> Opening a directory with a long path requires one read per path element for every transaction. This can create a hotspot on the directory's internal metadata subspace.</li>
<li><strong>Multi-Cluster Deployments:</strong> The directory prefix allocator is not safe for multi-cluster deployments and can allocate the same prefix in different clusters, leading to data corruption if the data is ever merged.</li>
<li><strong>Redwood and Prefix Compression:</strong> The Redwood storage engine (new in 7.0) provides native key-prefix compression. This offers many of the same space-saving benefits as the Directory Layer without the associated complexity and caveats. For new projects, especially those using Redwood, consider whether you can use subspaces with descriptive prefixes directly instead of relying on the Directory Layer.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../develop_layer/studiable-layers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../operate_fdb/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../develop_layer/studiable-layers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../operate_fdb/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
