<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tips and tricks - the FoundationDB Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../welcome.html">The FoundationDB Book</a></li><li class="chapter-item expanded affix "><li class="part-title">Meet FoundationDB</li><li class="chapter-item expanded "><a href="../meet_fdb/another_db.html"><strong aria-hidden="true">1.</strong> Yet another database?</a></li><li class="chapter-item expanded "><a href="../meet_fdb/enter_fdb.html"><strong aria-hidden="true">2.</strong> Enter FoundationDB</a></li><li class="chapter-item expanded "><a href="../meet_fdb/everything_is_kv.html"><strong aria-hidden="true">3.</strong> Everything is a key-value!</a></li><li class="chapter-item expanded "><a href="../meet_fdb/correctess.html"><strong aria-hidden="true">4.</strong> Correct and robust, choose both</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started with FoundationDB</li><li class="chapter-item expanded "><a href="../getting_started/installing-fdb.html"><strong aria-hidden="true">5.</strong> Installing FoundationDB</a></li><li class="chapter-item expanded "><a href="../getting_started/fdbcli.html"><strong aria-hidden="true">6.</strong> Playing with fdbcli</a></li><li class="chapter-item expanded affix "><li class="part-title">Developing a layer</li><li class="chapter-item expanded "><a href="../develop_layer/crafting-row-keys.html"><strong aria-hidden="true">7.</strong> Crafting row keys</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> TODO: Transaction</div></li><li class="chapter-item expanded "><a href="../develop_layer/tips.html" class="active"><strong aria-hidden="true">9.</strong> Tips and tricks</a></li><li class="chapter-item expanded affix "><li class="part-title">FoundationDB's internals</li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> TODO: the list of roles</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> TODO: the write-path</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> TODO: the read-path</div></li><li class="chapter-item expanded affix "><li class="part-title">The Record-Layer</li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> TODO: What is the Record-layer?</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> TODO: QuiCK</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
<script defer data-domain="pierrez.github.io/fdb-book" src="https://plausible.io/js/plausible.js"></script>                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">the FoundationDB Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PierreZ/fdb-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tips-and-tricks"><a class="header" href="#tips-and-tricks">Tips and tricks</a></h1>
<ul>
<li><a href="#about-the-run-method">About the <code>run</code> method</a></li>
<li><a href="#transaction-priority">Transaction priority</a></li>
<li><a href="#use-transaction-tagging">Use transaction Tagging</a></li>
<li><a href="#traces-logs">Traces logs</a></li>
<li><a href="#the-metadataversion">The <code>metadataVersion</code></a></li>
<li><a href="#the-timekeeper">The TimeKeeper</a></li>
<li><a href="#special-keys">Special keys</a></li>
<li><a href="#caveats-when-using-directory">Caveats when using directory</a></li>
</ul>
<p>Here's a few tips and tricks that should help you develop a production-ready layer.</p>
<h2 id="about-the-run-method"><a class="header" href="#about-the-run-method">About the <code>run</code> method</a></h2>
<p>Most bindings are offering a <code>run</code> method, that is taking a closure, like this in <a href="https://apple.github.io/foundationdb/javadoc/com/apple/foundationdb/Database.html#run(java.util.function.Function)">Java</a>.</p>
<p>You should use the <code>run</code> method on your bindings, <strong>BUT</strong> you must add some transactionOptions to avoid blocking forever:</p>
<ul>
<li><strong>Timeout</strong> Set a timeout in milliseconds which, when elapsed, will cause the transaction automatically to be cancelled.</li>
<li><strong>RetryLimit</strong> Set a maximum number of retries</li>
</ul>
<p>it is safe and legal to set these options at the first line of your <code>run</code> closure.</p>
<h2 id="transaction-priority"><a class="header" href="#transaction-priority">Transaction priority</a></h2>
<p>There is 3 transaction priority in FDB:</p>
<ul>
<li><strong>Default</strong>,</li>
<li><strong>Batch</strong> Specifies that this transaction should be treated as low priority and that default priority transactions will be processed first. Useful for doing batch work simultaneously with latency-sensitive work</li>
<li><strong>SystemImmediate</strong> Specifies that this transaction should be treated as highest priority and that lower priority transactions should block behind this one. Use is discouraged outside of low-level tools.</li>
</ul>
<h2 id="use-transaction-tagging"><a class="header" href="#use-transaction-tagging">Use transaction Tagging</a></h2>
<blockquote>
<p>FoundationDB provides the ability to add arbitrary byte-string tags to transactions. The cluster can be configured to limit the rate of transactions with certain tags, either automatically in response to tags that are very busy, or manually using the throttle command in fdbcli.</p>
</blockquote>
<p>More info can be found <a href="https://apple.github.io/foundationdb/transaction-tagging.html">here</a>.</p>
<h2 id="traces-logs"><a class="header" href="#traces-logs">Traces logs</a></h2>
<p>By default, clients do not generate trace logs. In order to enable traces from the clients, you must enable on the database-level:</p>
<ul>
<li><code>TraceEnable</code> Enables trace output to a file in a directory of the clients choosing</li>
</ul>
<p>You can also enable these optional options:</p>
<ul>
<li><code>TraceFormat</code> Select the format of the log files. xml (the default) and json are supported.</li>
<li><code>TraceLogGroup</code> Sets the ‘LogGroup’ attribute with the specified value for all events in the trace output files. The default log group is ‘default’.</li>
</ul>
<p>Then, on a Transaction-level, you can set these options:</p>
<ul>
<li><code>DebugTransactionIdentifier</code> String identifier to be used when tracing or profiling this transaction. The identifier must not exceed 100 characters.</li>
<li><code>LogTransaction</code> Enables tracing for this transaction and logs results to the client trace logs. The DEBUG_TRANSACTION_IDENTIFIER option must be set before using this option, and client trace logging must be enabled to get log output.</li>
<li><code>TransactionLoggingMaxFieldLength</code> Sets the maximum escaped length of key and value fields to be logged to the trace file via the LOG_TRANSACTION option, after which the field will be truncated. A negative value disables truncation.</li>
</ul>
<h2 id="the-metadataversion"><a class="header" href="#the-metadataversion">The <code>metadataVersion</code></a></h2>
<p>The metadata version key <code>\xFF/metadataVersion</code> is a key intended to help layers deal with hot keys. The value of this key is sent to clients along with the read version from the proxy, so a client can read its value without communicating with a storage server.</p>
<p>It is useful to implement some caching-strategy on a layer. More info on how to use the metadataVersion key can be found <a href="https://forums.foundationdb.org/t/sharing-the-metadataversionkey-for-multiple-tenants/1659">here</a>.</p>
<p>⚠️ In a transaction, if you update the \xff/metadataVersion key, and then attempt to read it again, I get a “Read or wrote an unreadable key” error (1036) when trying to read again. Context can be found <a href="https://forums.foundationdb.org/t/cannot-commit-transaction-that-reads-the-metadataversion-key-after-changing-it/1833">here</a></p>
<h2 id="the-timekeeper"><a class="header" href="#the-timekeeper">The TimeKeeper</a></h2>
<p><code>Cluster Controller</code> actor is keeping a map of read version to system clock time, updated every second. Can be accessible by scanning the <code>\xFF\x02/timeKeeper/map/</code>. More info <a href="https://forums.foundationdb.org/t/approximating-a-global-clock-for-a-watchdog-timer-using-versionstamps-readversions-or-the-timekeeper/477">here</a></p>
<h2 id="special-keys"><a class="header" href="#special-keys">Special keys</a></h2>
<blockquote>
<p>Keys starting with the bytes \xff\xff are called “special” keys, and they are materialized when read. \xff\xff/status/json is an example of a special key.</p>
</blockquote>
<p>More info can be found <a href="https://apple.github.io/foundationdb/special-keys.html">here</a></p>
<h2 id="caveats-when-using-directory"><a class="header" href="#caveats-when-using-directory">Caveats when using directory</a></h2>
<ul>
<li>
<p><a href="https://github.com/apple/foundationdb/issues/895">Mutating a directory multiple times simultaneously in the same transaction is unsafe</a></p>
</li>
<li>
<p>Opening a path with multiple items will generate many read on the metadata-subspace for every transaction. This can lead to hotspotting the <a href="https://forums.foundationdb.org/t/query-hotspotting-on-directory-layers-metadata-subspace/2487">Directory Layer’s metadata subspace</a>. Also, developing a directory that use the <a href="https://github.com/apple/foundationdb/pull/1213">metadataVersion's key</a> is not that easy:</p>
<ul>
<li><a href="https://forums.foundationdb.org/t/how-to-safely-add-a-metadata-caching-layer-on-top-of-existing-layers/1809/2?u=pierrez">Exhibit A</a>,</li>
<li><a href="https://github.com/apple/foundationdb/issues/1415">Exhibit B</a>.</li>
</ul>
</li>
<li>
<p>Because on how the prefix is generated, multi-cluster deployments can allocate the same <a href="https://forums.foundationdb.org/t/redwood-engine-and-directory-layer/3084/8">prefix multiple times</a>:</p>
</li>
<li>
<p>Redwood Engine is a new storage engine released in FDB-7.0. It has some nice features, including native key-prefix compression. Prefix compression's performance is likely to be <a href="https://youtu.be/5iqKu1pVDvE?t=158">similar to using the Directory</a>. When using the Redwood storage engine the remaining benefit of the Directory becomes the ability to move/rename directories and having smaller keys in network messages (though some of these may eventually use prefix compression).</p>
</li>
</ul>
<blockquote>
<p>I’ll also note that due to caching, the Record Layer can’t really make use of the directory layer’s renaming features (at least not without rethinking cache invalidation). I suspect that if we’d had Redwood and prefix compression when the Record Layer was being originally developed, we’d seriously have considered just relying on prefix compression instead of all of that because that would have significantly simplified cross-cluster data movement (and, if we’re honest, single cluster writes).</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../develop_layer/crafting-row-keys.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../develop_layer/crafting-row-keys.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>
    </body>
</html>
